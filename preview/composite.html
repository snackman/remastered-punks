<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remastered Punks - Compositing Preview</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            margin: 0;
        }
        h1 { text-align: center; color: #fff; }
        .subtitle { text-align: center; color: #888; margin-bottom: 30px; }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .controls label { display: flex; align-items: center; gap: 8px; }
        select, button {
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #2a2a4e;
            color: #fff;
            cursor: pointer;
        }
        button:hover { background: #3a3a6e; }
        .comparison {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        .punk-view { text-align: center; }
        .punk-view h3 { margin-bottom: 10px; color: #aaa; }
        .canvas-container {
            background: #638596;
            padding: 0;
            border-radius: 4px;
            display: inline-block;
        }
        canvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .info { margin-top: 10px; font-size: 12px; color: #888; }
        .traits {
            margin-top: 12px;
            font-size: 11px;
            text-align: left;
            max-width: 250px;
            margin-left: auto;
            margin-right: auto;
        }
        .traits .label { color: #666; font-size: 10px; text-transform: uppercase; margin-top: 8px; }
        .traits .value { color: #fff; margin-top: 2px; }
        .trait-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .trait-item {
            background: #3a3a6e;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .trait-item.remastered { background: #6a4a9e; }
        .layer-preview {
            margin-top: 40px;
            text-align: center;
        }
        .layers {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .layer {
            text-align: center;
        }
        .layer canvas {
            background: #638596;
        }
        .layer-name {
            font-size: 9px;
            color: #888;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <h1>Remastered Punks - Compositing</h1>
    <p class="subtitle">Re-compositing punks from individual trait sprites with remastered base</p>

    <div class="controls">
        <label>
            Punk ID:
            <select id="punkSelect"></select>
        </label>
        <label>
            Zoom:
            <select id="zoomSelect">
                <option value="4">4x</option>
                <option value="8" selected>8x</option>
                <option value="12">12x</option>
            </select>
        </label>
        <button id="randomBtn">Random</button>
    </div>

    <div class="comparison">
        <div class="punk-view">
            <h3>Original</h3>
            <div class="canvas-container">
                <canvas id="originalCanvas"></canvas>
            </div>
            <div class="info" id="originalInfo"></div>
        </div>
        <div class="punk-view">
            <h3>Recomposited (Standard)</h3>
            <div class="canvas-container">
                <canvas id="recompCanvas"></canvas>
            </div>
            <div class="info">From trait sprites</div>
        </div>
        <div class="punk-view">
            <h3>Remastered</h3>
            <div class="canvas-container">
                <canvas id="remasteredCanvas"></canvas>
            </div>
            <div class="info">Ear ↓1px, Shades ↓1px</div>
            <div class="traits" id="traitsInfo"></div>
        </div>
    </div>

    <div class="layer-preview">
        <h3 style="color: #aaa;">Compositing Layers</h3>
        <div class="layers" id="layersPreview"></div>
    </div>

    <script>
        // Eligible punks (Regular Shades Female)
        const ELIGIBLE_PUNKS = [70,94,169,176,244,262,342,479,509,527,589,874,875,921,976,1038,1043,1329,1354,1411,1418,1455,1457,1493,1514,1552,1666,1733,1758,1844,1872,1980,2068,2284,2286,2293,2428,2476,2481,2502,2544,2645,2696,2730,2743,2849,2852,2860,2891,2978,2984,3084,3277,3318,3343,3356,3646,3763,3842,3853,4016,4089,4183,4274,4339,4357,4368,4467,4554,4598,4615,4622,4626,4710,4729,4893,4980,5055,5086,5183,5285,5636,5673,5679,5781,5947,5983,6023,6102,6201,6215,6323,6377,6381,6576,6592,6708,6714,6804,6862,6939,6997,7052,7071,7153,7170,7378,7387,7562,7693,7987,8001,8058,8091,8241,8331,8421,8537,8623,8760,8952,9030,9223,9326,9524,9599,9781,9851];

        const SPRITE_SIZE = 24;
        const SPRITESHEET_COLS = 25;
        const PUNKS_COLS = 100;

        // Cropping: 24x24 → 22x22 (2px from top, 0px from bottom, 1px from sides)
        const CROP_TOP = 2;
        const CROP_LEFT = 1;
        const CROPPED_SIZE = 22;

        // Layer order for compositing
        const LAYER_ORDER = ['base', 'cheeks', 'blemish', 'hair', 'beard', 'eyes', 'eyewear', 'nose', 'mouth', 'mouthprop', 'earring', 'headgear', 'neck'];

        // Map trait names to layers
        const TRAIT_TO_LAYER = {
            // Cheeks
            'Rosy Cheeks': 'cheeks',
            // Blemish
            'Mole': 'blemish',
            'Spots': 'blemish',
            // Hair
            'Blonde Bob': 'hair', 'Blonde Short': 'hair', 'Clown Hair Green': 'hair',
            'Crazy Hair': 'hair', 'Dark Hair': 'hair', 'Frumpy Hair': 'hair',
            'Half Shaved': 'hair', 'Messy Hair': 'hair', 'Mohawk': 'hair',
            'Mohawk Dark': 'hair', 'Mohawk Thin': 'hair', 'Orange Side': 'hair',
            'Pigtails': 'hair', 'Pink With Hat': 'hair', 'Red Mohawk': 'hair',
            'Straight Hair': 'hair', 'Straight Hair Blonde': 'hair',
            'Straight Hair Dark': 'hair', 'Stringy Hair': 'hair',
            'Wild Blonde': 'hair', 'Wild Hair': 'hair', 'Wild White Hair': 'hair',
            // Eyes
            'Blue Eye Shadow': 'eyes', 'Green Eye Shadow': 'eyes',
            'Purple Eye Shadow': 'eyes', 'Clown Eyes Blue': 'eyes',
            'Clown Eyes Green': 'eyes',
            // Eyewear
            'Regular Shades': 'eyewear', 'Big Shades': 'eyewear',
            'Classic Shades': 'eyewear', 'Nerd Glasses': 'eyewear',
            'Horned Rim Glasses': 'eyewear', '3D Glasses': 'eyewear',
            'VR': 'eyewear', 'Welding Goggles': 'eyewear',
            'Eye Mask': 'eyewear', 'Eye Patch': 'eyewear',
            // Nose
            'Clown Nose': 'nose',
            // Mouth
            'Hot Lipstick': 'mouth', 'Black Lipstick': 'mouth',
            'Purple Lipstick': 'mouth',
            // MouthProp
            'Cigarette': 'mouthprop', 'Pipe': 'mouthprop', 'Vape': 'mouthprop',
            'Medical Mask': 'mouthprop',
            // Earring
            'Earring': 'earring',
            // Headgear
            'Bandana': 'headgear', 'Headband': 'headgear', 'Cap': 'headgear',
            'Knitted Cap': 'headgear', 'Pilot Helmet': 'headgear',
            'Tassle Hat': 'headgear', 'Tiara': 'headgear',
            // Neck
            'Choker': 'neck', 'Gold Chain': 'neck', 'Silver Chain': 'neck',
        };

        // Sprite IDs for female traits
        const SPRITE_IDS = {
            // Base heads by skin tone
            'base_Light': 24, 'base_Medium': 23, 'base_Dark': 22, 'base_Albino': 25,
            // All traits...
            'Regular Shades': 317, '3D Glasses': 302, 'Big Shades': 304,
            'Classic Shades': 306, 'Eye Mask': 308, 'Eye Patch': 310,
            'Horned Rim Glasses': 312, 'Nerd Glasses': 314, 'VR': 321,
            'Welding Goggles': 322, 'Blue Eye Shadow': 334, 'Green Eye Shadow': 335,
            'Purple Eye Shadow': 337, 'Clown Eyes Blue': 339, 'Clown Eyes Green': 341,
            'Mole': 345, 'Rosy Cheeks': 347, 'Spots': 349, 'Earring': 357,
            'Cigarette': 369, 'Medical Mask': 371, 'Pipe': 373, 'Vape': 375,
            'Bandana': 404, 'Headband': 416, 'Knitted Cap': 422, 'Pilot Helmet': 423,
            'Tassle Hat': 426, 'Tiara': 427, 'Cap': 548,
            'Blonde Short': 633, 'Crazy Hair': 635, 'Dark Hair': 637,
            'Frumpy Hair': 639, 'Half Shaved': 640, 'Messy Hair': 642,
            'Mohawk': 644, 'Mohawk Dark': 646, 'Mohawk Thin': 648,
            'Orange Side': 649, 'Pigtails': 651, 'Pink With Hat': 652,
            'Red Mohawk': 655, 'Straight Hair': 658, 'Straight Hair Blonde': 659,
            'Straight Hair Dark': 660, 'Stringy Hair': 662, 'Wild Blonde': 664,
            'Wild Hair': 666, 'Wild White Hair': 668, 'Blonde Bob': 749,
            'Clown Hair Green': 810,
            'Black Lipstick': 363, 'Hot Lipstick': 364, 'Purple Lipstick': 365,
            'Choker': 380, 'Gold Chain': 382, 'Silver Chain': 384,
        };

        // Hairstyles where ear is visible (need ear remaster)
        const EAR_VISIBLE_HAIRSTYLES = new Set([
            'Bandana', 'Headband', 'Cap', 'Knitted Cap', 'Mohawk', 'Mohawk Dark',
            'Mohawk Thin', 'Red Mohawk', 'Tiara', 'Welding Goggles'
        ]);

        // Hairstyles that HIDE the ear (do NOT include in EAR_VISIBLE_HAIRSTYLES):
        // - Pilot Helmet
        // - Half Shaved
        // - Pink With Hat
        // - Tassle Hat
        // - Frumpy Hair
        // - Straight Hair
        // - Straight Hair Blonde
        // - Straight Hair Dark
        // - Wild Hair
        // - Dark Hair

        let punksComposite = null;
        let spriteSheet = null;
        let punkTraits = null;
        let currentPunkId = ELIGIBLE_PUNKS[0];
        let currentZoom = 8;

        async function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function loadTraits() {
            const response = await fetch('../data/eligible-punk-traits.json');
            return response.json();
        }

        function extractPunk(punkId) {
            const row = Math.floor(punkId / PUNKS_COLS);
            const col = punkId % PUNKS_COLS;
            const canvas = document.createElement('canvas');
            canvas.width = SPRITE_SIZE;
            canvas.height = SPRITE_SIZE;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(punksComposite, col * SPRITE_SIZE, row * SPRITE_SIZE, SPRITE_SIZE, SPRITE_SIZE, 0, 0, SPRITE_SIZE, SPRITE_SIZE);
            return canvas;
        }

        function extractSprite(spriteId) {
            const row = Math.floor(spriteId / SPRITESHEET_COLS);
            const col = spriteId % SPRITESHEET_COLS;
            const canvas = document.createElement('canvas');
            canvas.width = SPRITE_SIZE;
            canvas.height = SPRITE_SIZE;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(spriteSheet, col * SPRITE_SIZE, row * SPRITE_SIZE, SPRITE_SIZE, SPRITE_SIZE, 0, 0, SPRITE_SIZE, SPRITE_SIZE);
            return canvas;
        }

        // Shift a sprite down by N pixels
        function shiftSpriteDown(canvas, pixels) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, SPRITE_SIZE, SPRITE_SIZE);
            const shifted = ctx.createImageData(SPRITE_SIZE, SPRITE_SIZE);

            for (let y = 0; y < SPRITE_SIZE - pixels; y++) {
                for (let x = 0; x < SPRITE_SIZE; x++) {
                    const srcIdx = (y * SPRITE_SIZE + x) * 4;
                    const dstIdx = ((y + pixels) * SPRITE_SIZE + x) * 4;
                    shifted.data[dstIdx] = imageData.data[srcIdx];
                    shifted.data[dstIdx + 1] = imageData.data[srcIdx + 1];
                    shifted.data[dstIdx + 2] = imageData.data[srcIdx + 2];
                    shifted.data[dstIdx + 3] = imageData.data[srcIdx + 3];
                }
            }

            const result = document.createElement('canvas');
            result.width = SPRITE_SIZE;
            result.height = SPRITE_SIZE;
            result.getContext('2d').putImageData(shifted, 0, 0);
            return result;
        }

        // Shift just the ear on a base head sprite
        function shiftEarOnBase(baseCanvas) {
            const ctx = baseCanvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, SPRITE_SIZE, SPRITE_SIZE);
            const data = imageData.data;

            const BG = {r: 99, g: 133, b: 150};
            const earPixels = [];
            let topEarY = 24; // Track the topmost ear pixel

            // Ear structure: outline at x=6, skin pixels at x=7
            // The ear is 2 pixels left of the eye (eye ~x=9, ear skin at x=7)
            // Scan x=6-7 for the ear area
            for (let x = 6; x <= 7; x++) {
                for (let y = 11; y <= 14; y++) {
                    const idx = (y * SPRITE_SIZE + x) * 4;
                    const r = data[idx], g = data[idx+1], b = data[idx+2], a = data[idx+3];

                    if (a === 0) continue;
                    // Skip background color
                    if (Math.abs(r - BG.r) < 10 && Math.abs(g - BG.g) < 10 && Math.abs(b - BG.b) < 10) continue;

                    // At x=7, only take ear pixels (not the full face column)
                    // The ear skin pixels are at y=12-14
                    if (x === 7) {
                        // Only include the ear skin pixels at y=12,13,14
                        if (y !== 12 && y !== 13 && y !== 14) continue;
                    }

                    earPixels.push({x, y, r, g, b, a});
                    if (x === 6 && y < topEarY) topEarY = y;
                }
            }

            // Clear original ear pixels (set to background)
            for (const p of earPixels) {
                const idx = (p.y * SPRITE_SIZE + p.x) * 4;
                data[idx] = BG.r;
                data[idx+1] = BG.g;
                data[idx+2] = BG.b;
                data[idx+3] = 255;
            }

            // Draw ear pixels 1 row down
            for (const p of earPixels) {
                const newY = p.y + 1;
                if (newY < SPRITE_SIZE) {
                    const idx = (newY * SPRITE_SIZE + p.x) * 4;
                    data[idx] = p.r;
                    data[idx+1] = p.g;
                    data[idx+2] = p.b;
                    data[idx+3] = p.a;
                }
            }

            // Fill the gap at the top with black outline pixel
            // The gap is at x=7 (above where the ear skin was)
            if (topEarY < 24) {
                const idx = (topEarY * SPRITE_SIZE + 7) * 4;
                data[idx] = 0;     // Black
                data[idx+1] = 0;
                data[idx+2] = 0;
                data[idx+3] = 255;
            }

            ctx.putImageData(imageData, 0, 0);
            return baseCanvas;
        }

        // Composite a punk from traits
        function compositePunk(skinTone, accessories, remaster = false) {
            const canvas = document.createElement('canvas');
            canvas.width = SPRITE_SIZE;
            canvas.height = SPRITE_SIZE;
            const ctx = canvas.getContext('2d');

            // Fill with background
            ctx.fillStyle = '#638596';
            ctx.fillRect(0, 0, SPRITE_SIZE, SPRITE_SIZE);

            // Get base head
            const baseId = SPRITE_IDS[`base_${skinTone}`];
            if (!baseId) {
                console.error('Unknown skin tone:', skinTone);
                return canvas;
            }

            let baseSprite = extractSprite(baseId);

            // If remastering and has ear-visible hairstyle, shift ear
            const hasEarVisible = accessories.some(a => EAR_VISIBLE_HAIRSTYLES.has(a));
            if (remaster && hasEarVisible) {
                baseSprite = shiftEarOnBase(baseSprite);
            }

            ctx.drawImage(baseSprite, 0, 0);

            // Sort accessories by layer order
            const sortedAccessories = [...accessories].sort((a, b) => {
                const layerA = TRAIT_TO_LAYER[a] || 'unknown';
                const layerB = TRAIT_TO_LAYER[b] || 'unknown';
                return LAYER_ORDER.indexOf(layerA) - LAYER_ORDER.indexOf(layerB);
            });

            // Draw each accessory
            for (const acc of sortedAccessories) {
                const spriteId = SPRITE_IDS[acc];
                if (!spriteId) {
                    console.warn('Unknown sprite for:', acc);
                    continue;
                }

                let sprite = extractSprite(spriteId);

                // If remastering Regular Shades, shift down
                if (remaster && acc === 'Regular Shades') {
                    sprite = shiftSpriteDown(sprite, 1);
                }

                // If remastering earring and ear is visible, shift down
                if (remaster && acc === 'Earring' && hasEarVisible) {
                    sprite = shiftSpriteDown(sprite, 1);
                }

                ctx.drawImage(sprite, 0, 0);
            }

            return canvas;
        }

        function drawZoomed(sourceCanvas, targetCanvas, zoom) {
            targetCanvas.width = CROPPED_SIZE * zoom;
            targetCanvas.height = CROPPED_SIZE * zoom;
            const ctx = targetCanvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(sourceCanvas, CROP_LEFT, CROP_TOP, CROPPED_SIZE, CROPPED_SIZE, 0, 0, CROPPED_SIZE * zoom, CROPPED_SIZE * zoom);
        }

        function renderPunk(punkId) {
            currentPunkId = punkId;
            const traits = punkTraits[punkId];

            if (!traits) {
                console.error('No traits for punk', punkId);
                return;
            }

            // Original punk from composite image
            const original = extractPunk(punkId);
            drawZoomed(original, document.getElementById('originalCanvas'), currentZoom);

            // Recomposited (standard, no remastering)
            const recomp = compositePunk(traits.skinTone, traits.accessories, false);
            drawZoomed(recomp, document.getElementById('recompCanvas'), currentZoom);

            // Remastered
            const remastered = compositePunk(traits.skinTone, traits.accessories, true);
            drawZoomed(remastered, document.getElementById('remasteredCanvas'), currentZoom);

            // Update info
            document.getElementById('originalInfo').textContent = `Punk #${punkId}`;

            // Traits info
            const hasEarVisible = traits.accessories.some(a => EAR_VISIBLE_HAIRSTYLES.has(a));
            const hasEarring = traits.accessories.includes('Earring');

            let fixes = ['Shades ↓1px'];
            if (hasEarVisible) fixes.push('Ear ↓1px');
            if (hasEarVisible && hasEarring) fixes.push('Earring ↓1px');

            document.getElementById('traitsInfo').innerHTML = `
                <div class="label">Skin Tone</div>
                <div class="value">${traits.skinTone}</div>
                <div class="label">Accessories</div>
                <div class="trait-list">
                    ${traits.accessories.map(a => {
                        const isRemastered = a === 'Regular Shades' ||
                            (a === 'Earring' && hasEarVisible) ||
                            EAR_VISIBLE_HAIRSTYLES.has(a);
                        return `<span class="trait-item${isRemastered ? ' remastered' : ''}">${a}</span>`;
                    }).join('')}
                </div>
                <div class="label">Fixes</div>
                <div class="trait-list">
                    ${fixes.map(f => `<span class="trait-item remastered">${f}</span>`).join('')}
                </div>
            `;

            // Show layer preview
            showLayers(traits);
        }

        function showLayers(traits) {
            const container = document.getElementById('layersPreview');
            container.innerHTML = '';

            // Base
            const baseId = SPRITE_IDS[`base_${traits.skinTone}`];
            if (baseId) {
                addLayerPreview(container, extractSprite(baseId), 'Base');
            }

            // Accessories in order
            const sorted = [...traits.accessories].sort((a, b) => {
                const layerA = TRAIT_TO_LAYER[a] || 'unknown';
                const layerB = TRAIT_TO_LAYER[b] || 'unknown';
                return LAYER_ORDER.indexOf(layerA) - LAYER_ORDER.indexOf(layerB);
            });

            for (const acc of sorted) {
                const spriteId = SPRITE_IDS[acc];
                if (spriteId) {
                    addLayerPreview(container, extractSprite(spriteId), acc);
                }
            }
        }

        function addLayerPreview(container, sprite, name) {
            const div = document.createElement('div');
            div.className = 'layer';

            const canvas = document.createElement('canvas');
            canvas.width = 48;
            canvas.height = 48;
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(sprite, 0, 0, 48, 48);

            const label = document.createElement('div');
            label.className = 'layer-name';
            label.textContent = name;

            div.appendChild(canvas);
            div.appendChild(label);
            container.appendChild(div);
        }

        function populateSelect() {
            const select = document.getElementById('punkSelect');
            ELIGIBLE_PUNKS.forEach(id => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `#${id}`;
                select.appendChild(option);
            });
        }

        async function init() {
            try {
                [punksComposite, spriteSheet, punkTraits] = await Promise.all([
                    loadImage('../data/punks.png'),
                    loadImage('../data/cryptopunks-assets/punks/config/punks-24x24.png'),
                    loadTraits()
                ]);

                populateSelect();

                document.getElementById('punkSelect').addEventListener('change', e => {
                    renderPunk(parseInt(e.target.value));
                });

                document.getElementById('zoomSelect').addEventListener('change', e => {
                    currentZoom = parseInt(e.target.value);
                    renderPunk(currentPunkId);
                });

                document.getElementById('randomBtn').addEventListener('click', () => {
                    const id = ELIGIBLE_PUNKS[Math.floor(Math.random() * ELIGIBLE_PUNKS.length)];
                    document.getElementById('punkSelect').value = id;
                    renderPunk(id);
                });

                renderPunk(ELIGIBLE_PUNKS[0]);
            } catch (err) {
                console.error('Init failed:', err);
                document.body.innerHTML = `<p style="color:red;text-align:center;padding:40px;">Error: ${err.message}</p>`;
            }
        }

        init();
    </script>
</body>
</html>
